<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>schulcloud-server documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../../images/favicon.ico">
	   <link rel="stylesheet" href="../../styles/style.css">
        <link rel="stylesheet" href="../../styles/dark.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../../" class="navbar-brand">schulcloud-server documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content additional-page">
                   <div class="content-data">





















<h1 id="erwin-idm-keycloak">ErWIn-IDM (Keycloak)</h1>
<blockquote>
<p>ErWIn-IDM, namely Keycloak, will be the future Identity Management System (IDM) for the dBildungscloud. Keycloak
provides OpenID Connect, SAML 2.0 and other identity related functionalities like SSO out of the box. It can
also act as identity broker or aggregate identities from third party services which can be an active directory or LDAP.</p>
</blockquote>
<h2 id="docker">Docker</h2>
<p>To run Keycloak locally for development purpose use the following Bash or PowerShell command. You can log into Keycloak
here <a href="http://localhost:8080">http://localhost:8080</a>. If you don&#39;t want to block your terminal, you can add the <code>-d</code> option to start the container
in the background. Execute these commands in the repository root or the data seeding will fail, and you can not log into
Keycloak with any user.</p>
<p><strong>Bash:</strong></p>
<div><pre class="line-numbers"><code class="language-bash">docker run \
  --name erwinidm \
  -p 8080:8080 \
  -p 8443:8443 \
  -v &quot;$PWD/backup/idm/keycloak:/tmp/realms&quot; \
  ghcr.io/hpi-schul-cloud/erwin-idm/dev:latest \
  &quot;&amp;&amp; /opt/keycloak/bin/kc.sh import --dir /tmp/realms&quot;</code></pre></div><p><strong>PowerShell:</strong></p>
<div><pre class="line-numbers"><code class="language-pwsh">docker run `
  --name erwinidm `
  -p 8080:8080 `
  -p 8443:8443 `
  -v &quot;$PWD/backup/idm/keycloak:/tmp/realms&quot; `
  ghcr.io/hpi-schul-cloud/erwin-idm/dev:latest `
  &quot;&amp;&amp; /opt/keycloak/bin/kc.sh import --dir /tmp/realms&quot;</code></pre></div><h3 id="setup-openid-connect-identity-provider-mock-for-erwin-idm-brokering">Setup OpenID Connect Identity Provider mock for ErWIn-IDM brokering</h3>
<p>To add ErWIn-IDM identity broker feature via OpenID Connect (OIDC) Identity Provider (IdP) mock follow the steps below. Execute these commands in the repository root.</p>
<ul>
<li>Set env vars (or in your .env file) &#39;OIDCMOCK__BASE_URL&#39; to http://&lt;your-local-ip&gt;:4011.</li>
<li>To make it work with the nuxt client set the env var HOST=<a href="http://localhost:4000">http://localhost:4000</a></li>
<li>re-trigger <code>npm run setup:db</code> and <code>npm run setup:idm</code> to reset and apply seed data.</li>
<li>start the &#39;oidc-server-mock&#39; as follows:</li>
</ul>
<div><pre class="line-numbers"><code class="language-bash">docker run \
  --name oidc-server-mock \
  -p 4011:80 \
  -e ASPNETCORE_ENVIRONMENT=&#39;Development&#39; \
  -e SERVER_OPTIONS_PATH=&#39;/tmp/config/server-config.json&#39; \
  -e USERS_CONFIGURATION_PATH=&#39;/tmp/config/users-config.json&#39; \
  -e CLIENTS_CONFIGURATION_PATH=&#39;/tmp/config/clients-config.json&#39; \
  -v &quot;$PWD/backup/idm/oidcmock:/tmp/config&quot; \
  ghcr.io/soluto/oidc-server-mock:0.6.0</code></pre></div><p><strong>PowerShell:</strong></p>
<div><pre class="line-numbers"><code class="language-pwsh">docker run `
  --name oidc-server-mock `
  -p 4011:80 `
  -e ASPNETCORE_ENVIRONMENT=&#39;Development&#39; `
  -e SERVER_OPTIONS_PATH=&#39;/tmp/config/server-config.json&#39; `
  -e USERS_CONFIGURATION_PATH=&#39;/tmp/config/users-config.json&#39; `
  -e CLIENTS_CONFIGURATION_PATH=&#39;/tmp/config/clients-config.json&#39; `
  -v &quot;$PWD/backup/idm/oidcmock:/tmp/config&quot; `
  ghcr.io/soluto/oidc-server-mock:0.6.0</code></pre></div><h2 id="test-local-environment">Test local environment</h2>
<p>You may test your local setup executing &#39;keycloak-identity-management.integration.spec.ts&#39;:</p>
<div><pre class="line-numbers"><code class="language-pwsh">npx jest apps/server/src/shared/infra/identity-management/keycloak/service/keycloak-identity-management.service.integration.spec.ts</code></pre></div><h2 id="seeding-data">Seeding Data</h2>
<p>During container startup Keycloak will always create the Master realm with the admin user. After startup, we use the
Keycloak-CLI to import the dBildungscloud realm, which contains some seed users, groups and permissions for development
and testing. In the table below you can see the username and password combinations for the Keycloak login.</p>
<table class="table table-bordered compodoc-table">
<thead>
<tr>
<th align="left">Username</th>
<th align="left">Password</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">keycloak</td>
<td align="left">keycloak</td>
<td align="left">The overall Keycloak administrator with all permissions.</td>
</tr>
<tr>
<td align="left">dbildungscloud</td>
<td align="left">dBildungscloud</td>
<td align="left">The dBildungscloud realm specific administrator.</td>
</tr>
</tbody>
</table>
<h2 id="updating-seed-data">Updating Seed Data</h2>
<ol>
<li>Run Keycloak and make the desired changes</li>
<li>Use <code>docker container exec -it keycloak bash</code> to start a bash in the container</li>
<li>Use the Keycloak-CLI to export all Keycloak data with <code>/opt/keycloak/bin/kc.sh export --dir /tmp/realms</code></li>
<li>Save your changes with a commit</li>
<li>If you start your container with a command from the docker section, your changes will be directly applied to the starting Keycloak container</li>
</ol>
<blockquote>
<p>IMPORTANT: During the export process there will be some errors, that&#39;s because the export process will be done on the
same port as the Keycloak server. This leads to Keycloak failing to start the server in import/export mode. Due to the
transition from WildFly to Quarkus as application server there is currently no documentation on this topic.</p>
</blockquote>
<p>In order to re-apply the seeding data for a running keycloak container, you may run following commands (to be executed in the repository root):</p>
<ol>
<li><code>docker cp ./backup/idm/keycloak keycloak:/tmp/realms</code></li>
<li><code>docker exec erwinidm /opt/keycloak/bin/kc.sh import --dir /tmp/realms</code></li>
</ol>
<h2 id="npm-commands">NPM Commands</h2>
<p>A list of available NPM commands regarding Keycloak / IDM.</p>
<table class="table table-bordered compodoc-table">
<thead>
<tr>
<th align="left">Command</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">setup:idm:seed</td>
<td align="left">Seeds users for development and testing purpose into the IDM</td>
</tr>
<tr>
<td align="left">setup:idm:configure</td>
<td align="left">Configures identity and authentication providers and other details in the IDM</td>
</tr>
</tbody>
</table>

                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 2;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'additional-page';
            var COMPODOC_CURRENT_PAGE_URL = 'keycloak.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../../js/libs/custom-elements.min.js"></script>
       <script src="../../js/libs/lit-html.js"></script>

       <script src="../../js/menu-wc.js" defer></script>
       <script nomodule src="../../js/menu-wc_es5.js" defer></script>

       <script src="../../js/libs/bootstrap-native.js"></script>

       <script src="../../js/libs/es6-shim.min.js"></script>
       <script src="../../js/libs/EventDispatcher.js"></script>
       <script src="../../js/libs/promise.min.js"></script>
       <script src="../../js/libs/zepto.min.js"></script>

       <script src="../../js/compodoc.js"></script>

       <script src="../../js/tabs.js"></script>
       <script src="../../js/menu.js"></script>
       <script src="../../js/libs/clipboard.min.js"></script>
       <script src="../../js/libs/prism.js"></script>
       <script src="../../js/sourceCode.js"></script>
          <script src="../../js/search/search.js"></script>
          <script src="../../js/search/lunr.min.js"></script>
          <script src="../../js/search/search-lunr.js"></script>
          <script src="../../js/search/search_index.js"></script>
       <script src="../../js/lazy-load-graphs.js"></script>


    </body>
</html>
