<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>schulcloud-server documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">schulcloud-server documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">













<ol class="breadcrumb">
  <li>Interfaces</li>
  <li
  >
  ISyncData</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>apps/server/src/modules/files/uc/sync-files-storage.service.ts</code>
        </p>




        <section>
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                        <a href="#bucket" 
>
                                            bucket
                                        </a>
                                </li>
                                <li>
                                        <a href="#client" 
>
                                            client
                                        </a>
                                </li>
                                <li>
                                        <a href="#objectPath" 
>
                                            objectPath
                                        </a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section>
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="bucket"></a>
                                        <span class="name "><b>bucket</b>
                                            <a href="#bucket">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>bucket:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="client"></a>
                                        <span class="name "><b>client</b>
                                            <a href="#client">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>client:     <code>S3Client</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>S3Client</code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="objectPath"></a>
                                        <span class="name "><b>objectPath</b>
                                            <a href="#objectPath">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>objectPath:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { DeleteObjectCommand, GetObjectCommand, S3Client } from &#x27;@aws-sdk/client-s3&#x27;;
import { Upload } from &#x27;@aws-sdk/lib-storage&#x27;;
import { Inject, Injectable, OnModuleInit } from &#x27;@nestjs/common&#x27;;
import { EntityId } from &#x27;@shared/domain&#x27;;
import { StorageProviderRepo } from &#x27;@shared/repo&#x27;;
import { S3Config } from &#x27;@src/modules/files-storage/interface/config&#x27;;
import { SyncFileItem } from &#x27;../types&#x27;;

// Temporary functionality for migration to new fileservice
// TODO: Remove when BC-1496 is done!

export interface ISyncData {
	client: S3Client;
	bucket: string;
	objectPath: string;
}

@Injectable()
export class SyncFilesStorageService implements OnModuleInit {
	private destinationClient: S3Client;

	private sourceClients: Map&lt;EntityId, S3Client&gt; &#x3D; new Map();

	constructor(
		private storageProviderRepo: StorageProviderRepo,
		@Inject(&#x27;DESTINATION_S3_CONFIG&#x27;) readonly config: S3Config
	) {
		this.destinationClient &#x3D; this.createDestinationProvider(config);
	}

	async onModuleInit() {
		await this.setSourceProviders();
	}

	async syncS3File(item: SyncFileItem): Promise&lt;void&gt; {
		const client &#x3D; this.sourceClients.get(item.source.storageProviderId);
		if (client) {
			const source: ISyncData &#x3D; {
				client,
				bucket: item.source.bucket,
				objectPath: item.source.storageFileName,
			};
			const target: ISyncData &#x3D; {
				client: this.destinationClient,
				bucket: this.config.bucket,
				objectPath: [item.schoolId, item.target?.id].join(&#x27;/&#x27;),
			};

			await this.syncFile(source, target);
		} else {
			throw new Error(&#x60;Unable to find storage provider with id ${item.source.storageProviderId}&#x60;);
		}
	}

	async removeFile(path: string) {
		const req &#x3D; new DeleteObjectCommand({
			Bucket: this.config.bucket,
			Key: path,
		});

		return this.destinationClient.send(req);
	}

	private createDestinationProvider(config: S3Config) {
		const provider &#x3D; this.createStorageProviderClient({
			endpoint: config.endpoint,
			bucket: config.bucket,
			region: config.region,
			accessKeyId: config.accessKeyId,
			secretAccessKey: config.secretAccessKey,
		});

		return provider;
	}

	private async setSourceProviders() {
		const providers &#x3D; await this.storageProviderRepo.findAll();

		providers.forEach((item) &#x3D;&gt; {
			const client &#x3D; this.createStorageProviderClient({
				endpoint: item.endpointUrl,
				region: item.region || &#x27;eu-central-1&#x27;,
				accessKeyId: item.accessKeyId,
				secretAccessKey: item.secretAccessKey,
				bucket: &#x27;&#x27;,
			});
			this.sourceClients.set(item.id, client);
		});
	}

	private createStorageProviderClient(storageProvider: S3Config): S3Client {
		return new S3Client({
			endpoint: storageProvider.endpoint,
			forcePathStyle: true,
			region: storageProvider.region,
			tls: true,
			credentials: {
				accessKeyId: storageProvider.accessKeyId,
				secretAccessKey: storageProvider.secretAccessKey,
			},
		});
	}

	private async syncFile(source: ISyncData, target: ISyncData) {
		const sourceReq &#x3D; new GetObjectCommand({
			Bucket: source.bucket,
			Key: source.objectPath,
		});
		try {
			const data &#x3D; await source.client.send(sourceReq);

			const targetReq &#x3D; {
				Body: data.Body,
				Bucket: target.bucket,
				Key: target.objectPath,
				ContentType: data.ContentType,
			};
			const res &#x3D; new Upload({
				client: target.client,
				params: targetReq,
			});

			const a &#x3D; await res.done();

			return a;
		} catch (err) {
			// eslint-disable-next-line @typescript-eslint/no-unsafe-member-access
			if (err.name &amp;&amp; err.name &#x3D;&#x3D;&#x3D; &#x27;NoSuchKey&#x27;) {
				throw new Error(&#x60;S3 file not found: bucket &#x3D; ${source.bucket}, objectPath &#x3D; ${source.objectPath}&#x60;);
			}
			throw err;
		}
	}
}
</code></pre>
    </div>
</div>








                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'ISyncData.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
