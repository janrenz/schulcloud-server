<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>schulcloud-server documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">schulcloud-server documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">













<ol class="breadcrumb">
  <li>Interfaces</li>
  <li
  >
  ICollectionFilePath</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>apps/server/src/modules/management/uc/database-management.uc.ts</code>
        </p>




        <section>
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                        <a href="#collectionName" 
>
                                            collectionName
                                        </a>
                                </li>
                                <li>
                                        <a href="#filePath" 
>
                                            filePath
                                        </a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section>
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="collectionName"></a>
                                        <span class="name "><b>collectionName</b>
                                            <a href="#collectionName">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>collectionName:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="filePath"></a>
                                        <span class="name "><b>filePath</b>
                                            <a href="#filePath">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>filePath:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Inject, Injectable } from &#x27;@nestjs/common&#x27;;
import { orderBy } from &#x27;lodash&#x27;;
import { FileSystemAdapter } from &#x27;@shared/infra/file-system&#x27;;
import { DatabaseManagementService } from &#x27;@shared/infra/database&#x27;;
import { Configuration } from &#x27;@hpi-schul-cloud/commons&#x27;;
import { DefaultEncryptionService, IEncryptionService, LdapEncryptionService } from &#x27;@shared/infra/encryption&#x27;;
import { StorageProvider, System } from &#x27;@shared/domain&#x27;;
import { ConfigService } from &#x27;@nestjs/config&#x27;;
import { Logger } from &#x27;@src/core/logger&#x27;;
import { BsonConverter } from &#x27;../converter/bson.converter&#x27;;

export interface ICollectionFilePath {
	filePath: string;
	collectionName: string;
}

const systemsCollectionName &#x3D; &#x27;systems&#x27;;
const storageprovidersCollectionName &#x3D; &#x27;storageproviders&#x27;;

const defaultSecretReplacementHintText &#x3D; &#x27;replace with secret placeholder&#x27;;

@Injectable()
export class DatabaseManagementUc {
	/**
	 * relative path to seed data folder based of location of this file.
	 */
	private basePath &#x3D; &#x27;../../../../../../backup&#x27;;

	constructor(
		private fileSystemAdapter: FileSystemAdapter,
		private databaseManagementService: DatabaseManagementService,
		private bsonConverter: BsonConverter,
		private readonly configService: ConfigService,
		private readonly logger: Logger,
		@Inject(DefaultEncryptionService) private readonly defaultEncryptionService: IEncryptionService,
		@Inject(LdapEncryptionService) private readonly ldapEncryptionService: IEncryptionService
	) {
		this.logger.setContext(DatabaseManagementUc.name);
	}

	/**
	 * absolute path reference for seed data base folder.
	 */
	private get baseDir(): string {
		const folderPath &#x3D; this.fileSystemAdapter.joinPath(__dirname, this.basePath);
		return folderPath;
	}

	/**
	 * setup dir with json files
	 */
	private getSeedFolder() {
		return this.fileSystemAdapter.joinPath(this.baseDir, &#x27;setup&#x27;);
	}

	/**
	 * export folder name based on current date
	 * @returns
	 */
	private getTargetFolder(toSeedFolder?: boolean) {
		if (toSeedFolder &#x3D;&#x3D;&#x3D; true) {
			const targetFolder &#x3D; this.getSeedFolder();
			return targetFolder;
		}
		const now &#x3D; new Date();
		const currentDateTime &#x3D; &#x60;${now.getFullYear()}_${
			now.getMonth() + 1
		}_${now.getDate()}_${now.getHours()}_${now.getMinutes()}_${now.getSeconds()}&#x60;;
		const targetFolder &#x3D; this.fileSystemAdapter.joinPath(this.baseDir, currentDateTime);
		return targetFolder;
	}

	/**
	 * Loads all collection names from database and adds related file paths.
	 * @returns {ICollectionFilePath}
	 */
	private async loadAllCollectionsFromDatabase(targetFolder: string): Promise&lt;ICollectionFilePath[]&gt; {
		const collections &#x3D; await this.databaseManagementService.getCollectionNames();
		const collectionsWithFilePaths &#x3D; collections.map((collectionName) &#x3D;&gt; {
			return {
				filePath: this.fileSystemAdapter.joinPath(targetFolder, &#x60;${collectionName}.json&#x60;),
				collectionName,
			};
		});
		return collectionsWithFilePaths;
	}

	/**
	 * Loads all collection names and file paths from backup files.
	 * @returns {ICollectionFilePath}
	 */
	private async loadAllCollectionsFromFilesystem(baseDir: string): Promise&lt;ICollectionFilePath[]&gt; {
		const filenames &#x3D; await this.fileSystemAdapter.readDir(baseDir);
		const collectionsWithFilePaths &#x3D; filenames.map((fileName) &#x3D;&gt; {
			return {
				filePath: this.fileSystemAdapter.joinPath(baseDir, fileName),
				collectionName: fileName.split(&#x27;.&#x27;)[0],
			};
		});
		return collectionsWithFilePaths;
	}

	/**
	 * Scans &lt;source&gt; for existing collections and optionally filters them based on &lt;collectionNameFilter&gt;
	 * @param source
	 * @param collectionNameFilter
	 * @returns {ICollectionFilePath} the filtered collection names and related file paths
	 */
	private async loadCollectionsAvailableFromSourceAndFilterByCollectionNames(
		source: &#x27;files&#x27; | &#x27;database&#x27;,
		folder: string,
		collectionNameFilter?: string[]
	) {
		let allCollectionsWithFilePaths: ICollectionFilePath[] &#x3D; [];

		// load all available collections from source
		if (source &#x3D;&#x3D;&#x3D; &#x27;files&#x27;) {
			allCollectionsWithFilePaths &#x3D; await this.loadAllCollectionsFromFilesystem(folder);
		} else {
			// source &#x3D;&#x3D;&#x3D; &#x27;database&#x27;
			allCollectionsWithFilePaths &#x3D; await this.loadAllCollectionsFromDatabase(folder);
		}

		// when a collection name filter is given, apply it and check
		if (Array.isArray(collectionNameFilter) &amp;&amp; collectionNameFilter.length &gt; 0) {
			const filteredCollectionsWithFilePaths &#x3D; allCollectionsWithFilePaths.filter(({ collectionName }) &#x3D;&gt;
				collectionNameFilter?.includes(collectionName)
			);

			if (filteredCollectionsWithFilePaths.length !&#x3D;&#x3D; collectionNameFilter.length) {
				throw new Error(
					&#x60;At least one collectionName of ${JSON.stringify(
						collectionNameFilter
					)} is invalid. Collection names available in &#x27;${source}&#x27; are: ${JSON.stringify(
						allCollectionsWithFilePaths.map((file) &#x3D;&gt; file.collectionName)
					)}&#x60;
				);
			}

			return filteredCollectionsWithFilePaths;
		}

		return allCollectionsWithFilePaths;
	}

	/**
	 * Imports all or filtered &lt;collections&gt; from filesystem as bson to database.
	 * The behaviour should match $ mongoimport
	 * @param collections optional filter applied on existing collections
	 * @returns the list of collection names exported
	 */
	async seedDatabaseCollectionsFromFileSystem(collections?: string[]): Promise&lt;string[]&gt; {
		// detect collections to seed based on filesystem data
		const setupPath &#x3D; this.getSeedFolder();
		const collectionsToSeed &#x3D; await this.loadCollectionsAvailableFromSourceAndFilterByCollectionNames(
			&#x27;files&#x27;,
			setupPath,
			collections
		);

		const seededCollectionsWithAmount: string[] &#x3D; [];

		await Promise.all(
			collectionsToSeed.map(async ({ filePath, collectionName }) &#x3D;&gt; {
				// load text from backup file
				let fileContent &#x3D; await this.fileSystemAdapter.readFile(filePath);

				if (collectionName &#x3D;&#x3D;&#x3D; systemsCollectionName || collectionName &#x3D;&#x3D;&#x3D; storageprovidersCollectionName) {
					fileContent &#x3D; this.injectEnvVars(fileContent);
				}

				// create bson-objects from text
				const bsonDocuments &#x3D; JSON.parse(fileContent) as unknown[];
				// deserialize bson (format of mongoexport) to json documents we can import to mongo
				const jsonDocuments &#x3D; this.bsonConverter.deserialize(bsonDocuments);

				// hint: collection drop/create is very slow, delete all documents instead
				const collectionExists &#x3D; await this.databaseManagementService.collectionExists(collectionName);
				if (collectionExists) {
					// clear existing documents, if collection exists
					await this.databaseManagementService.clearCollection(collectionName);
				} else {
					// create collection
					await this.databaseManagementService.createCollection(collectionName);
				}

				this.encryptSecrets(collectionName, jsonDocuments);

				// import backup data into database collection
				const importedDocumentsAmount &#x3D; await this.databaseManagementService.importCollection(
					collectionName,
					jsonDocuments
				);
				// keep collection name and number of imported documents
				seededCollectionsWithAmount.push(&#x60;${collectionName}:${importedDocumentsAmount}&#x60;);
			})
		);
		return seededCollectionsWithAmount;
	}

	/**
	 * Exports all or defined &lt;collections&gt; from database as bson to filesystem.
	 * The behaviour should match $ mongoexport
	 * @param collections optional filter applied on existing collections
	 * @param toSeedFolder optional override existing seed data files
	 * @returns the list of collection names exported
	 */
	async exportCollectionsToFileSystem(collections?: string[], toSeedFolder?: boolean): Promise&lt;string[]&gt; {
		const targetFolder &#x3D; this.getTargetFolder(toSeedFolder);
		await this.fileSystemAdapter.createDir(targetFolder);
		// detect collections to export based on database collections
		const collectionsToExport &#x3D; await this.loadCollectionsAvailableFromSourceAndFilterByCollectionNames(
			&#x27;database&#x27;,
			targetFolder,
			collections
		);
		const exportedCollections: string[] &#x3D; [];

		await Promise.all(
			collectionsToExport.map(async ({ filePath, collectionName }) &#x3D;&gt; {
				// load json documents from collection
				const jsonDocuments &#x3D; await this.databaseManagementService.findDocumentsOfCollection(collectionName);
				this.removeSecrets(collectionName, jsonDocuments);
				// serialize to bson (format of mongoexport)
				const bsonDocuments &#x3D; this.bsonConverter.serialize(jsonDocuments);
				// sort results to have &#x27;new&#x27; data added at documents end
				const sortedBsonDocuments &#x3D; orderBy(bsonDocuments, [&#x27;_id.$oid&#x27;, &#x27;createdAt.$date&#x27;], [&#x27;asc&#x27;, &#x27;asc&#x27;]);
				// convert to text
				const TAB &#x3D; &#x27;	&#x27;;
				const json &#x3D; JSON.stringify(sortedBsonDocuments, undefined, TAB);
				// persist to filesystem
				await this.fileSystemAdapter.writeFile(filePath, json + this.fileSystemAdapter.EOL);
				// keep collection name and number of exported documents
				exportedCollections.push(&#x60;${collectionName}:${sortedBsonDocuments.length}&#x60;);
			})
		);
		return exportedCollections;
	}

	/**
	 * Updates the indexes in the database based on definitions in entities
	 */
	async syncIndexes(): Promise&lt;void&gt; {
		return this.databaseManagementService.syncIndexes();
	}

	private injectEnvVars(json: string): string {
		// replace ${VAR} with VAR content
		json &#x3D; json.replace(/(?&lt;!\\)\$\{(.*?)\}/g, (placeholder) &#x3D;&gt;
			this.resolvePlaceholder(placeholder.substring(2, placeholder.length - 1))
		);
		// replace \$ with $ (escaped placeholder sequence)
		json &#x3D; json.replace(/\\\$/g, &#x27;$&#x27;);
		return json;
	}

	private resolvePlaceholder(placeholder: string) {
		if (Configuration.has(placeholder)) {
			return Configuration.get(placeholder) as string;
		}
		const placeholderValue &#x3D; this.configService.get&lt;string&gt;(placeholder);
		if (placeholderValue) {
			return placeholderValue;
		}
		this.logger.warn(&#x60;Placeholder &quot;${placeholder}&quot; could not be resolved!&#x60;);
		return &#x27;&#x27;;
	}

	private encryptSecrets(collectionName: string, jsonDocuments: unknown[]) {
		if (collectionName &#x3D;&#x3D;&#x3D; systemsCollectionName) {
			this.encryptSecretsInSystems(jsonDocuments as System[]);
		}
	}

	private encryptSecretsInSystems(systems: System[]) {
		systems.forEach((system) &#x3D;&gt; {
			if (system.oauthConfig) {
				system.oauthConfig.clientSecret &#x3D; this.defaultEncryptionService.encrypt(system.oauthConfig.clientSecret);
			}
			if (system.oidcConfig) {
				system.oidcConfig.clientSecret &#x3D; this.defaultEncryptionService.encrypt(system.oidcConfig.clientSecret);
			}
			if (system.ldapConfig) {
				system.ldapConfig.searchUserPassword &#x3D; this.ldapEncryptionService.encrypt(
					system.ldapConfig.searchUserPassword as string
				);
			}
		});
		return systems;
	}

	/**
	 * Removes all known secrets (hard coded) from the export.
	 * Manual replacement with the intend placeholders or value is mandatory.
	 * Currently this affects system and storageproviders collections.
	 */
	private removeSecrets(collectionName: string, jsonDocuments: unknown[]) {
		if (collectionName &#x3D;&#x3D;&#x3D; systemsCollectionName) {
			this.removeSecretsFromSystems(jsonDocuments as System[]);
		}
		if (collectionName &#x3D;&#x3D;&#x3D; storageprovidersCollectionName) {
			this.removeSecretsFromStorageproviders(jsonDocuments as StorageProvider[]);
		}
	}

	private removeSecretsFromStorageproviders(storageProviders: StorageProvider[]) {
		storageProviders.forEach((storageProvider) &#x3D;&gt; {
			storageProvider.accessKeyId &#x3D; defaultSecretReplacementHintText;
			storageProvider.secretAccessKey &#x3D; defaultSecretReplacementHintText;
		});
	}

	private removeSecretsFromSystems(systems: System[]) {
		systems.forEach((system) &#x3D;&gt; {
			if (system.oauthConfig) {
				system.oauthConfig.clientSecret &#x3D; defaultSecretReplacementHintText;
			}
			if (system.oidcConfig) {
				system.oidcConfig.clientSecret &#x3D; defaultSecretReplacementHintText;
			}
			if (system.ldapConfig) {
				system.ldapConfig.searchUserPassword &#x3D; defaultSecretReplacementHintText;
			}
		});
		return systems;
	}
}
</code></pre>
    </div>
</div>








                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'ICollectionFilePath.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
